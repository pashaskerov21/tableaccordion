<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/3cf65b98ce.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>

    <div class="container py-5">

        <div class="table__button__rows">
            <div class="table__button table__button__delete">Sil</div>
        </div>
        <div class="table__wrapper">
            <div class="general__table">
                <div class="thead">
                    <div class="tr">
                        <div class="th limited"></div>
                        <div class="th limited">
                            <div class="checkbox__item select__all" data-id="1">
                                <i class="fa-solid fa-check"></i>
                            </div>
                        </div>
                        <div class="th">#</div>
                        <div class="th">Ad</div>
                        <div class="th">Soyad</div>
                        <div class="th">Email</div>
                        <div class="th">Nömrə</div>
                    </div>
                </div>
                <div class="tbody" data-parent="0">
                    <div class="mr no-child" data-id="3" data-index="5">
                        <div class="tr">
                            <div class="td limited">
                                <button class="arrow__button" data-id="3"><i
                                        class="fa-solid fa-caret-down"></i></button>
                            </div>
                            <div class="td limited">
                                <div class="checkbox__item" data-id="3">
                                    <i class="fa-solid fa-check"></i>
                                </div>
                            </div>
                            <div class="td">3</div>
                            <div class="td">Pasa</div>
                            <div class="td">Askerov</div>
                            <div class="td">pasa@mail.com</div>
                            <div class="td">055 555 55 55</div>
                        </div>
                    </div>
                    <div class="mr no-child" data-id="4" data-index="10">
                        <div class="tr">
                            <div class="td limited">
                                <button class="arrow__button" data-id="4"><i
                                        class="fa-solid fa-caret-down"></i></button>
                            </div>
                            <div class="td limited">
                                <div class="checkbox__item" data-id="4">
                                    <i class="fa-solid fa-check"></i>
                                </div>
                            </div>
                            <div class="td">4</div>
                            <div class="td">Pasa</div>
                            <div class="td">Askerov</div>
                            <div class="td">pasa@mail.com</div>
                            <div class="td">055 555 55 55</div>
                        </div>
                    </div>
                    <div class="mr no-child" data-id="5" data-index="15">
                        <div class="tr">
                            <div class="td limited">
                                <button class="arrow__button" data-id="5"><i
                                        class="fa-solid fa-caret-down"></i></button>
                            </div>
                            <div class="td limited">
                                <div class="checkbox__item" data-id="5">
                                    <i class="fa-solid fa-check"></i>
                                </div>
                            </div>
                            <div class="td">5</div>
                            <div class="td">Pasa</div>
                            <div class="td">Askerov</div>
                            <div class="td">pasa@mail.com</div>
                            <div class="td">055 555 55 55</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- jQuery and SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-sortablejs@latest/jquery-sortable.js"></script>

    <script>
        $(document).ready(function () {
            $('.general__table .tbody').sortable({
                group: {
                    pull: true,
                    put: true
                },
                animation: 200,
                ghostClass: 'ghost',
                items: '.mr',
                handle: '.mr',
                multiDrag: true,
                avoidImplicitDeselect: true,
                onEnd: function (evt) {
                    let allRows = $('.mr');
                    let activeOrderData = [];
                    let orderData = [];

                    let dataIndexArray = [];

                    $(allRows).each(function (index, element) {
                        dataIndexArray.push($(element).data('index'));
                    });
                    dataIndexArray = dataIndexArray.sort((a, b) => a - b);
                    allRows.each(function (index, element) {
                        let newIndex = dataIndexArray[index];
                        $(element).attr('data-index', newIndex);
                    });
                    $(allRows).each(function (index, element) {
                        let id = $(element).data('id');
                        let parentID = $(element).parent('.tbody').data('parent');
                        let order = dataIndexArray[index];
                        let obj = {
                            id: id,
                            order: order,
                            parent: parentID,
                        }
                        orderData.push(obj);
                    });
                    if (evt.items.length === 0) {
                        let activeRow = orderData.find((data) => data.id === $(evt.item).data('id'));
                        activeOrderData.push(activeRow)
                    } else {
                        let activeRows = Array.from(evt.items).map((item) =>
                            orderData.find((data) => data.id == item.getAttribute('data-id'))).
                            filter((row) => row !== undefined);
                        activeOrderData.push(activeRows);
                    }
                    saveOrderFunction(evt.items.length === 0 || evt.items.length === 1 ? activeOrderData[0] : activeOrderData, orderData)
                },
                onSelect: function (evt) {
                    $('.table__button__rows').addClass('active')
                },
                onDeselect: function (evt) {
                    if ($('.mr.sortable-selected').length === 0) {
                        $('.table__button__rows').removeClass('active')
                    }
                    if ($('.mr').length !== $('.mr.sortable-selected').length) {
                        $('.checkbox__item.select__all').removeClass('check__active')
                    }
                },
                handle: '.mr'
            });

            $('.mr').click(function () {
                let id = $(this).data('id');
                let checkbox = $(this).find(`input[type="checkbox"][data-id="${id}"]`);
                if ($(this).hasClass('sortable-selected')) {
                    checkbox.prop('checked', true);
                } else {
                    checkbox.prop('checked', false);
                }
            });
            $('.mr').mousedown(function () {
                let id = $(this).data('id');
                let checkbox = $(this).find(`input[type="checkbox"][data-id="${id}"]`);
                checkbox.prop('checked', true);
            });
        });


        function saveOrderFunction(activeOrderData, orderData) {
            console.log('Sürüşdürülən sətir(lər)', activeOrderData);
            console.log('Bütün sətirlər', orderData);
        }

        $('.checkbox__item.select__all').click(function () {
            $(this).toggleClass('check__active');
            $('.mr').toggleClass('sortable-selected');
            if ($('.mr').hasClass('sortable-selected')) {
                $('.mr').addClass('sortable-selected');
            } else {
                $('.mr').removeClass('sortable-selected');
            }

            if ($('.mr.sortable-selected').length === 0) {
                $('.table__button__rows').removeClass('active');
            } else {
                $('.table__button__rows').addClass('active');
            }
        })

        $('.table__button__delete').click(function () {
            const selectedRows = $('.mr.sortable-selected');
            const rowIds = selectedRows.map(function (index, row) {
                return $(row).data('id');
            }).get();
            console.log('Silinən sətirlər', rowIds);
        });
    </script>


    <script>
        // table toggle 
        $(document).ready(function () {
            const btn = $('.mr.has-child button');

            btn.click(function () {
                const id = $(this).attr('data-id');
                const main = $(this).closest('.mr');
                const sub = $(`.sub__table__wrapper[data-parent="${id}"]`);

                $(this).toggleClass('sub__active');
                main.toggleClass('sub__active');
                sub.toggle();

            })
        })
    </script>
</body>

</html>